let quillVi,quillEn,currentArticleId=null;function initEditors(){const e=[[{header:[2,3,!1]}],["bold","italic","underline","strike"],["blockquote","code-block"],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],["link","image","video"],[{color:[]},{background:[]}],[{align:[]}],["clean"]];quillVi=new Quill("#editorVi",{theme:"snow",modules:{toolbar:e},placeholder:"Vi·∫øt n·ªôi dung b√†i vi·∫øt ·ªü ƒë√¢y... S·ª≠ d·ª•ng c√°c c√¥ng c·ª• ph√≠a tr√™n gi·ªëng nh∆∞ Microsoft Word."}),quillEn=new Quill("#editorEn",{theme:"snow",modules:{toolbar:e},placeholder:"Write your article content here... Use the tools above like Microsoft Word."})}function initLanguageTabs(){document.querySelectorAll(".lang-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.lang;document.querySelectorAll(".lang-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".lang-content").forEach(e=>{e.classList.remove("active")}),document.querySelector(`.lang-content[data-lang="${t}"]`).classList.add("active")})})}function showView(e){const t={editor:document.getElementById("editorView"),list:document.getElementById("listView"),media:document.getElementById("mediaView")};Object.values(t).forEach(e=>e.classList.add("hidden")),t[e].classList.remove("hidden"),"list"===e?loadArticlesList():"media"===e&&loadMediaLibrary()}function showAlert(e,t="success"){const a=document.getElementById("alertContainer"),i=document.createElement("div");i.className=`alert alert-${t}`,i.innerHTML=`<i class="fas fa-${"success"===t?"check-circle":"danger"===t?"exclamation-circle":"info-circle"}"></i><span>${e}</span>`,a.appendChild(i),setTimeout(()=>{i.remove()},5e3)}function generateSlug(e){const t={√†:"a",√°:"a",·∫£:"a",√£:"a",·∫°:"a",ƒÉ:"a",·∫±:"a",·∫Ø:"a",·∫≥:"a",·∫µ:"a",·∫∑:"a",√¢:"a",·∫ß:"a",·∫•:"a",·∫©:"a",·∫´:"a",·∫≠:"a",√®:"e",√©:"e",·∫ª:"e",·∫Ω:"e",·∫π:"e",√™:"e",·ªÅ:"e",·∫ø:"e",·ªÉ:"e",·ªÖ:"e",·ªá:"e",√¨:"i",√≠:"i",·ªâ:"i",ƒ©:"i",·ªã:"i",√≤:"o",√≥:"o",·ªè:"o",√µ:"o",·ªç:"o",√¥:"o",·ªì:"o",·ªë:"o",·ªï:"o",·ªó:"o",·ªô:"o",∆°:"o",·ªù:"o",·ªõ:"o",·ªü:"o",·ª°:"o",·ª£:"o",√π:"u",√∫:"u",·ªß:"u",≈©:"u",·ª•:"u",∆∞:"u",·ª´:"u",·ª©:"u",·ª≠:"u",·ªØ:"u",·ª±:"u",·ª≥:"y",√Ω:"y",·ª∑:"y",·ªπ:"y",·ªµ:"y",ƒë:"d",√Ä:"A",√Å:"A",·∫¢:"A",√É:"A",·∫†:"A",ƒÇ:"A",·∫∞:"A",·∫Æ:"A",·∫≤:"A",·∫¥:"A",·∫∂:"A",√Ç:"A",·∫¶:"A",·∫§:"A",·∫®:"A",·∫™:"A",·∫¨:"A",√à:"E",√â:"E",·∫∫:"E",·∫º:"E",·∫∏:"E",√ä:"E",·ªÄ:"E",·∫æ:"E",·ªÇ:"E",·ªÑ:"E",·ªÜ:"E",√å:"I",√ç:"I",·ªà:"I",ƒ®:"I",·ªä:"I",√í:"O",√ì:"O",·ªé:"O",√ï:"O",·ªå:"O",√î:"O",·ªí:"O",·ªê:"O",·ªî:"O",·ªñ:"O",·ªò:"O",∆†:"O",·ªú:"O",·ªö:"O",·ªû:"O",·ª†:"O",·ª¢:"O",√ô:"U",√ö:"U",·ª¶:"U",≈®:"U",·ª§:"U",∆Ø:"U",·ª™:"U",·ª®:"U",·ª¨:"U",·ªÆ:"U",·ª∞:"U",·ª≤:"Y",√ù:"Y",·ª∂:"Y",·ª∏:"Y",·ª¥:"Y",ƒê:"D"};let a=e.toLowerCase();for(const[e,i]of Object.entries(t))a=a.replace(new RegExp(e,"g"),i);return a=a.replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}async function generateStaticPages(e){console.log("Generated static pages for:",e.title_vi),showAlert(`üìÑ ƒê√£ t·∫°o trang: tin-tuc/${e.slug_vi}.html v√† en/news/${e.slug_en}.html`,"info")}function resetForm(){document.getElementById("articleForm").reset(),quillVi.setContents([]),quillEn.setContents([]),currentArticleId=null}async function loadArticlesList(){const e=document.getElementById("articlesList");e.innerHTML='<div class="spinner"></div>';try{const t=await fetch("tables/news_articles?limit=50"),a=await t.json();if(a.data&&a.data.length>0){const t=a.data.map(e=>{const t={published:"badge-published",draft:"badge-draft",archived:"badge-archived"}[e.status]||"badge-draft",a=new Date(e.published_date).toLocaleDateString("vi-VN");return`<div class="article-item"><div class="article-item-header"><h3>${e.title_vi}</h3><span class="badge ${t}">${e.status}</span></div><div class="article-item-meta"><span>üìÖ ${a}</span><span>üìÇ ${e.category_vi}</span><span>üë§ ${e.author}</span></div><div class="article-item-actions"><button onclick="editArticle('${e.id}')" class="btn btn-sm btn-secondary">‚úèÔ∏è S·ª≠a</button><button onclick="deleteArticle('${e.id}')" class="btn btn-sm btn-danger">üóëÔ∏è X√≥a</button></div></div>`}).join("");e.innerHTML=t}else e.innerHTML='<p class="empty-state">Ch∆∞a c√≥ b√†i vi·∫øt n√†o. T·∫°o b√†i vi·∫øt ƒë·∫ßu ti√™n!</p>'}catch(t){console.error("Error loading articles:",t),e.innerHTML='<p class="error-state">Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i vi·∫øt</p>'}}async function editArticle(e){try{const t=await(await fetch(`tables/news_articles/${e}`)).json();currentArticleId=e,document.getElementById("titleVi").value=t.title_vi,document.getElementById("titleEn").value=t.title_en,document.getElementById("excerptVi").value=t.excerpt_vi,document.getElementById("excerptEn").value=t.excerpt_en,quillVi.root.innerHTML=t.content_vi,quillEn.root.innerHTML=t.content_en,document.getElementById("category").value=t.category,document.getElementById("featuredImage").value=t.featured_image||"",document.getElementById("author").value=t.author,document.getElementById("readTime").value=t.read_time,document.getElementById("status").value=t.status,showView("editor"),showAlert("‚úèÔ∏è ƒêang ch·ªânh s·ª≠a b√†i vi·∫øt: "+t.title_vi,"info")}catch(e){console.error("Error loading article:",e),showAlert("‚ùå Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt","danger")}}async function deleteArticle(e){if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y?"))return;try{(await fetch(`tables/news_articles/${e}`,{method:"DELETE"})).ok?(showAlert("‚úÖ ƒê√£ x√≥a b√†i vi·∫øt","success"),loadArticlesList()):showAlert("‚ùå Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt","danger")}catch(e){console.error("Error deleting article:",e),showAlert("‚ùå L·ªói khi x√≥a b√†i vi·∫øt","danger")}}async function loadMediaLibrary(){document.getElementById("mediaLibrary").innerHTML='<p class="empty-state">Media library ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai</p>'}document.getElementById("articleForm").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("titleVi").value.trim(),a=document.getElementById("titleEn").value.trim(),i=document.getElementById("excerptVi").value.trim(),l=document.getElementById("excerptEn").value.trim(),r=quillVi.root.innerHTML,c=quillEn.root.innerHTML,s=document.getElementById("category").value,n=document.getElementById("featuredImage").value.trim(),d=document.getElementById("author").value.trim(),o=parseInt(document.getElementById("readTime").value),u=document.getElementById("status").value,m=[];if(t||m.push("Ti√™u ƒë·ªÅ (Ti·∫øng Vi·ªát)"),a||m.push("Title (English)"),i||m.push("T√≥m t·∫Øt (Ti·∫øng Vi·ªát)"),l||m.push("Excerpt (English)"),s||m.push("Danh m·ª•c"),m.length>0)return void showAlert(`‚ùå Thi·∫øu th√¥ng tin: ${m.join(", ")}`,"danger");const g=quillVi.getText().trim().length,h=quillEn.getText().trim().length;if(g<50)return void showAlert(`‚ùå N·ªôi dung Ti·∫øng Vi·ªát qu√° ng·∫Øn (${g}/50 k√Ω t·ª±). Vui l√≤ng vi·∫øt th√™m!`,"danger");if(h<50)return void showAlert(`‚ùå N·ªôi dung English qu√° ng·∫Øn (${h}/50 k√Ω t·ª±). Vui l√≤ng vi·∫øt th√™m!`,"danger");const E=generateSlug(t),A=generateSlug(a),v={"cong-nghe":{vi:"C√¥ng Ngh·ªá",en:"Technology"},"du-an":{vi:"D·ª± √Ån",en:"Projects"},"huong-dan":{vi:"H∆∞·ªõng D·∫´n",en:"Guides"}},p={title_vi:t,title_en:a,slug_vi:E,slug_en:A,category:s,category_vi:v[s].vi,category_en:v[s].en,excerpt_vi:i,excerpt_en:l,content_vi:r,content_en:c,featured_image:n||"",media_gallery:[],author:d||"FrameX Team",read_time:o||5,published_date:(new Date).toISOString(),status:u,meta_description_vi:i.substring(0,160),meta_description_en:l.substring(0,160)};console.log("üìù Saving article:",{titleVi:t,titleEn:a,category:s,status:u,contentViLength:g,contentEnLength:h});try{let e;if(e=currentArticleId?await fetch(`tables/news_articles/${currentArticleId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}):await fetch("tables/news_articles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}),e.ok){const a=await e.json();showAlert(`‚úÖ B√†i vi·∫øt "${t}" ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!`,"success"),await generateStaticPages(a),resetForm(),setTimeout(()=>showView("list"),2e3)}else{const t=await e.text();console.error("API Error:",e.status,t),showAlert(`‚ùå L·ªói API (${e.status}): ${t||"Kh√¥ng th·ªÉ l∆∞u b√†i vi·∫øt"}`,"danger")}}catch(e){console.error("Error saving article:",e),showAlert(`‚ùå L·ªói: ${e.message||"Kh√¥ng th·ªÉ l∆∞u b√†i vi·∫øt. Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng!"}`,"danger")}}),document.addEventListener("DOMContentLoaded",()=>{initEditors(),initLanguageTabs()});